<!DOCTYPE html>
<html class="light" lang="th">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô - BIGBOS</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;700&family=Noto+Sans+Thai:wght@300;400;500;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="assets/js/tailwind-config.js"></script>
    <script type="importmap">
    {
        "imports": {
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>
</head>

<body class="bg-[#f9fafb] text-primary font-display min-h-screen">


    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="flex items-center gap-2 mb-6">
            <a href="products.html" class="flex items-center text-gray-500 hover:text-primary">
                <span class="material-symbols-outlined">arrow_back</span> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡πà‡∏≠
            </a>
            <h1 class="text-2xl font-bold ml-auto">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h1>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined">shopping_cart</span> ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                    </h2>
                    <div id="cart-items" class="space-y-4">
                        <p class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined">local_shipping</span> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
                    </h2>
                    <form id="checkout-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                <input type="text" id="ship_name" required
                                    class="w-full rounded-lg border-gray-300 focus:ring-primary focus:border-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                <input type="tel" id="ship_phone" required placeholder="0812035307"
                                    class="w-full rounded-lg border-gray-300 focus:ring-primary focus:border-primary">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
                            <textarea id="ship_address" required rows="3"
                                placeholder="‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏ñ‡∏ô‡∏ô, ‡∏ï‡∏≥‡∏ö‡∏•, ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"
                                class="w-full rounded-lg border-gray-300 focus:ring-primary focus:border-primary"></textarea>
                        </div>
                    </form>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 sticky top-4">
                    <h2 class="text-lg font-bold mb-4">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>

                    <div class="space-y-3 mb-6">
                        <label
                            class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-primary has-[:checked]:bg-gray-50">
                            <input type="radio" name="payment" value="qr" class="text-primary focus:ring-primary"
                                checked onchange="togglePayment('qr')">
                            <div class="ml-3">
                                <span class="block font-medium">‡∏™‡πÅ‡∏Å‡∏ô QR Code</span>
                                <span class="block text-xs text-gray-500">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</span>
                            </div>
                        </label>

                        <div id="qr-section" class="p-4 bg-gray-100 rounded-lg flex flex-col items-center text-center">
                            <p class="text-sm font-bold mb-2">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
                            <img id="qr-image" src="" alt="Payment QR"
                                class="w-40 h-40 bg-white p-2 rounded shadow-sm object-contain">
                            <p class="text-sm font-bold mt-2 text-primary">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ò‡∏ô‡∏≤‡∏Å‡∏£ ‡∏•‡∏î‡∏Å‡∏£‡∏∞‡πÇ‡∏ó‡∏Å</p>
                            <p class="text-xs text-red-500 mt-1">*‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</p>
                        </div>

                        <label
                            class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-primary has-[:checked]:bg-gray-50">
                            <input type="radio" name="payment" value="cod" class="text-primary focus:ring-primary"
                                onchange="togglePayment('cod')">
                            <div class="ml-3">
                                <span class="block font-medium">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (COD)</span>
                                <span class="block text-xs text-gray-500">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (+3%)</span>
                            </div>
                        </label>
                    </div>

                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                            <span id="subtotal">‡∏ø0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</span>
                            <span>‡∏ø100</span>
                        </div>
                        <div class="flex justify-between text-xl font-black mt-4">
                            <span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
                            <span id="total" class="text-primary">‡∏ø0</span>
                        </div>
                    </div>

                    <button onclick="placeOrder()"
                        class="w-full mt-6 bg-primary text-white py-3 rounded-lg font-bold hover:bg-black transition-transform active:scale-95 shadow-lg">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getCurrentUser } from './assets/js/auth-utils.js';
        import { placeOrder as placeOrderUtils } from './assets/js/orders-utils.js';

        // Attach global functions to window
        window.togglePayment = togglePayment;
        window.placeOrder = placeOrder;
        window.updateQty = updateQty;
        window.removeItem = removeItem;
        window.loadCart = loadCart;

        let currentTotal = 0;
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ô QR Code ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á
        function updatePromptPayQR(amount) {
            // ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            const myPromptPayID = "0611156858";
            const qrImage = document.getElementById('qr-image');

            if (amount > 0) {
                // ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ QR Code ‡∏à‡∏≤‡∏Å API ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô
                qrImage.src = `https://promptpay.io/${myPromptPayID}/${amount}`;
            }
        }
        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const container = document.getElementById('cart-items');
            let subtotal = 0;

            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ <br> <a href="products.html" class="text-primary underline">‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏•‡∏¢</a></div>';
                document.getElementById('subtotal').innerText = '‡∏ø0';
                document.getElementById('total').innerText = '‡∏ø0';
                currentTotal = 0;
                return;
            }

            container.innerHTML = '';
            cart.forEach((item, index) => {
                const itemTotal = (item.price || 0) * item.quantity;
                subtotal += itemTotal;
                container.innerHTML += `
                <div class="flex gap-4 py-4 border-b last:border-0 items-start">
                    <img src="${item.image}" class="w-20 h-20 object-contain bg-gray-100 rounded-md border border-gray-200" onerror="this.src='https://via.placeholder.com/100'">
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-sm text-gray-900 truncate">${item.name}</h3>
                        <p class="text-gray-500 text-xs mt-0.5">${Number(item.price).toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                        <div class="flex items-center gap-3 mt-3">
                            <div class="flex items-center border border-gray-300 rounded-lg">
                                <button onclick="updateQty(${index}, -1)" class="w-7 h-7 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded-l-lg">-</button>
                                <span class="text-sm font-medium w-8 text-center">${item.quantity}</span>
                                <button onclick="updateQty(${index}, 1)" class="w-7 h-7 flex items-center justify-center text-gray-600 hover:bg-gray-100 rounded-r-lg">+</button>
                            </div>
                            <button onclick="removeItem(${index})" class="text-xs text-red-500 hover:text-red-700 underline decoration-red-500/30">‡∏•‡∏ö</button>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-sm font-bold text-gray-900">‡∏ø${itemTotal.toLocaleString()}</span>
                    </div>
                </div>
            `;
            });

            currentTotal = subtotal + 100;
            document.getElementById('subtotal').innerText = '‡∏ø' + subtotal.toLocaleString();
            document.getElementById('total').innerText = '‡∏ø' + currentTotal.toLocaleString();

            updatePromptPayQR(currentTotal);
        }

        function updateQty(index, change) {
            let cart = JSON.parse(localStorage.getItem('cart'));
            cart[index].quantity += change;
            if (cart[index].quantity < 1) cart[index].quantity = 1;
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }

        function removeItem(index) {
            let cart = JSON.parse(localStorage.getItem('cart'));
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }

        function togglePayment(method) {
            document.getElementById('qr-section').classList.toggle('hidden', method !== 'qr');
        }

        async function placeOrder() {
            // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏¢‡∏±‡∏á
            const user = getCurrentUser();

            if (!user) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
                window.location.href = 'login.html';
                return;
            }

            // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) return alert('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤');

            // 3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà
            const name = document.getElementById('ship_name').value;
            const phone = document.getElementById('ship_phone').value;
            const address = document.getElementById('ship_address').value;
            if (!name || !phone || !address) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');

            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                const btn = document.querySelector('button[onclick="placeOrder()"]');
                const oldText = btn.innerText;
                btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
                btn.disabled = true;

                try {
                    const orderData = {
                        items: cart,
                        total: currentTotal,
                        user: user.username,
                        customerName: name,
                        customerPhone: phone,
                        customerAddress: address,
                        paymentMethod: document.querySelector('input[name="payment"]:checked').value === 'qr' ? '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (QR)' : '‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (COD)',
                        dateStr: new Date().toLocaleDateString('th-TH') + ' ' + new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' })
                    };

                    const newOrder = await placeOrderUtils(orderData);

                    // 6. ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ + ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                    localStorage.removeItem('cart');
                    alert('üéâ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ' + newOrder.id);
                    window.location.href = 'history.html'; // Ensure this page exists or redirect to products
                } catch (e) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
                    btn.innerText = oldText;
                    btn.disabled = false;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', loadCart);
    </script>

</body>

</html>